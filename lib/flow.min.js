var FILE_ENCODING="utf-8",EOL="\n",fs=require("fs"),exec=require("child_process").exec,stylus=require("stylus"),util=require("util"),wrench=require("wrench"),Flow={};typeof exports!="undefined"&&(exports=module.exports=function(path){return Flow.path=path,Flow}),Flow.compile={},Flow.compile.html=function(o,callback){var command=Flow.path.markx+" ",md=o.md||!1,output=o.output||!1,jade=o.jade||!1,src=!1;jade&&md&&(command+="--template "+jade+" ",src=md),jade&&!md&&(src=jade),!jade&&md&&(src=md),output&&src&&(command+=src+" > ",command+=output,fs.unlinkSync(output),exec(command,function(error,stdout,stderr){error!==null?(console.log("exec error: "+error),console.log("stdout: "+stdout),console.log("stderr: "+stderr)):callback()}))},Flow.compile.stylus=function(o){o=o||{};var output=o.output||!1,paths=o.paths||!1,src=o.src||!1;stylus(fs.readFileSync(src,"utf8")).set("paths",paths).render(function(err,css){fs.writeFileSync(output,css,"utf8")})},Flow.compiler=function(o){o=o||{};var calledDir=o.calledDir||!1,files=o.files||[],frameworks,list,minify,out,output,src,srcList,type=o.type||!1;if(calledDir&&files&&type)switch(type){case"html":for(file in files){output=files[file].toString()||!1,src=file.toString()||!1;if(output&&src){var command=Flow.path.markx+" "+calledDir+src+" > "+calledDir+output;exec(command,function(error,stdout,stderr){error!==null&&console.log("exec error: "+error)})}}break;case"js":files.forEach(function(file,key){frameworks=file.frameworks||!1,output=file.output||!1,src=file.src||!1,output&&src&&(srcList=src.map(function(srcItem){return calledDir+srcItem}),frameworks?list=frameworks.concat(srcList):list=srcList,out=list.map(function(item){return fs.readFileSync(item,FILE_ENCODING)}),fs.writeFileSync(calledDir+output,out.join(EOL),FILE_ENCODING))})}},Flow.init=function(o){o=o||{};var watch=o.watch||!0,fileList=[],calledDir=Flow.path.called,configPath=calledDir+"/flow.json",config=require(configPath),project=config.project||!1;fileList.push(calledDir+"/flow.json");if(project){var css=project.css||!1,html=project.html||!1,js=project.js||!1;if(css)for(cssFile in css.files)Flow.compile[css.engine]({output:calledDir+css.files[cssFile],src:calledDir+cssFile,paths:[calledDir+"/src/stylus/"]}),fileList.push(calledDir+cssFile.toString());if(html&&html.files){Flow.compiler({calledDir:calledDir,files:html.files,type:"html"});for(htmlFile in html.files)fileList.push(calledDir+htmlFile.toString())}js&&js.files&&(Flow.compiler({calledDir:calledDir,files:js.files,type:"js"}),js.files.forEach(function(file,key){file.frameworks&&file.frameworks.forEach(function(file,key){fileList.push(file.toString())}),file.src.forEach(function(file,key){fileList.push(calledDir+file.toString())})}))}},Flow.watch=function(o){o=o||{};var file=o.file||!1;file&&(console.log("Watching: ",file),fs.watch(file,{persistant:!0,internal:1e3},function(ev,file){console.log(" "),console.log("Compiling..."),console.log(" "),Flow.init({watch:!1})}))}