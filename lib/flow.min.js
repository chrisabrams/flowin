var FILE_ENCODING="utf-8",EOL="\n",_fs=require("fs"),exec=require("child_process").exec,util=require("util"),Flow={};typeof exports!="undefined"&&(exports=module.exports=function(path){return Flow.path=path,Flow}),Flow.compile={},Flow.compile.Jade=function(o){o=o||{};var calledDir=o.calledDir||!1,input=o.input||!1,output=o.output||!1,command=Flow.path.markx+" "+calledDir+input+" > "+calledDir+output;exec(command,function(error,stdout,stderr){error!==null&&console.log("exec error: "+error)})},Flow.compile.Js=function(o){o=o||{};var calledDir=o.calledDir||!1,destination=o.destination||!1,frameworks=o.frameworks||!1,input=o.input||!1,list,output=o.output||!1,src=o.src||!1;if(destination&&src){var srcList=src.map(function(srcItem){return calledDir+srcItem});frameworks?list=frameworks.concat(srcList):list=srcList;var out=list.map(function(item){return _fs.readFileSync(item,FILE_ENCODING)});_fs.writeFileSync(calledDir+destination,out.join(EOL),FILE_ENCODING)}if(input&&output){var file=_fs.readFileSync(calledDir+input,FILE_ENCODING);_fs.writeFileSync(calledDir+output,file,FILE_ENCODING)}},Flow.compile.Singles=function(o){o=o||{};var calledDir=o.calledDir||!1,files=o.files||!1,filetype,input,output;if(files)for(file in files){input=file.toString(),output=files[file].toString(),filetype=input.substr(input.lastIndexOf(".")+1);switch(filetype){case"jade":Flow.compile.Jade({calledDir:calledDir,input:input,output:output});break;case"js":Flow.compile.Js({calledDir:calledDir,input:input,output:output});break;default:}}},Flow.watch=function(o){o=o||{};var file=o.file||!1;file&&_fs.watch(file,{persistant:!0},function(ev,file){Flow.compiler({watch:!1})})},Flow.compiler=function(o){o=o||{};var watch=o.watch||!0,fileList=[],calledDir=Flow.path.called,configPath=calledDir+"/flow.json",config=require(configPath),project=config.project||!1;if(project){var css=project.css||!1,html=project.html||!1,js=project.js||!1;!css;if(html&&html.singles){Flow.compile.Singles({calledDir:calledDir,files:html.singles});for(htmlSingle in html.singles)fileList.push(htmlSingle.toString())}if(js){js.destination&&js.frameworks&&js.src&&(Flow.compile.Js({calledDir:calledDir,destination:js.destination||!1,frameworks:js.frameworks||!1,src:js.src||!1}),js.src.forEach(function(val,key){fileList.push(val.toString())}));if(js.singles){Flow.compile.Singles({calledDir:calledDir,files:js.singles});for(jsSingle in html.singles)fileList.push(jsSingle.toString())}}}watch&&fileList.forEach(function(val,key){Flow.watch({file:calledDir+val})})}